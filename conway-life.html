<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conway’s Game of Life</title>
  <style>

    body {
      margin: 0;
      text-align: middle;
    }

    .toolbar {
      margin: auto;
      background-color: rgba(7, 122, 167, 0.986);
      height: 50px;
      vertical-align: middle;
      line-height: 230%;
      text-align: center;
      color: white;
      position: sticky;
      top: 0;
      left: 0;
      right: 0;
    }

    #grid {
      margin: auto;
      background-color: rgb(207, 228, 236);
      text-align: center;
    }

    #grid input {
      margin: 2px;
    }
    #grid div {
      height: 16px;
    }

    #creatures {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      background-color: rgba(7, 122, 167, 0.986);
      display: flex;
      padding: 0 10px;
      justify-content: center;
    }

    #creatures img {
      height: 70%;
      align-self: center;
      margin-left: 10px;
    }
    .info {
      margin: auto;
      display: flex;
      justify-content: center;
      column-gap: 15px;
      font-size: 16px;
      position: sticky;
      top: 50px;
      background-color: #fff;
    }

    .info span {
      flex: 0 1 120px
    }

  </style>
</head>
<body>
  <div class="toolbar">
    <button id="clear">清空</button>
    <button id="next">迭代</button>
    <button id="random">随机</button>
    <label><input id="autoplay" type="checkbox">自动迭代</label>
    <select id="selection">
      <option value="200">200毫秒</option>
      <option value="500">500毫秒</option>
      <option value="1000">1000毫秒</option>
    </select>
    <input type="range" min="2" max="60" id="rowRange"><span></span>
    <input type="range" min="2" max="60" id="colRange"><span></span>
    <label><input id="noBoundry"type="checkbox">无边界</label>
  </div>
  <div class="info">
  </div>
  <div id="grid"></div>
  <div id="creatures">
    <img src="./ConwayCreatures/120px-Game_of_life_block.svg.png" title="石头" value="block" alt="">
    <img src="./ConwayCreatures/120px-Game_of_life_loaf.svg.png" title="面包" value="loaf" alt="">
    <img src="./ConwayCreatures/120px-Game_of_life_beehive.svg.png" title="蜂巢" value="beehive" alt="">
    <img src="./ConwayCreatures/120px-Game_of_life_5x5_ship.svg.png" title="大船" value="ship" alt="">
    <img src="./ConwayCreatures/120px-Game_of_life_boat.svg.png" title="小船" value="boat" alt="">
    <img src="./ConwayCreatures/Game_of_life_flower.svg.png" title="花朵" value="flower" alt="">
    <img src="./ConwayCreatures/120px-Game_of_life_6x6_pond.svg.png" title="池塘" value="pond" alt="">
    <img src="./ConwayCreatures/Conways_game_of_life_snake.png" title="蛇" value="snake" alt="">
    <img src="./ConwayCreatures/Conways_game_of_life_aircraft_carrier.png" title="" value="aircraft_carrier" alt="">
    <img src="./ConwayCreatures/Conways_game_of_life_canoe.png" title="独木舟" value="canoe" alt="">
    <img src="./ConwayCreatures/Conways_game_of_life_mango.png" title="芒果" value="mango" alt="">
    <img src="./ConwayCreatures/Conways_game_of_life_duck.png" title="鸭" value="duck" alt="">

  </div>


  <script>

    class ConwayLife {
      constructor(m=2, n=2) {
        this.m = m
        this.n = n
        this.table
        this.cellStatus = {
          'mount': this.m * this.n,
          'alive': 0,
          'dead': 0,
          'vanish': 0,
          'reborn': 0,
          'static': 0,
        }
      }

    createTable(m=this.m, n=this.n) {
      this.table = []
      for (let i = 0; i < m; i++) {
        this.table.push(Array(n).fill(0).map(it => Math.floor(Math.random()+0.5)))
      }
      this.m = m
      this.n = n
      return this.table
    }

    renewTablefromEvolve() {
      let table = this.table
      this.cellStatus = {
        'mount': this.m * this.n,
        'alive': 0,
        'dead': 0,
        'vanish': 0,
        'reborn': 0,
        'static': 0,
      }
      let cellStatus = this.cellStatus
      let oldTable = table.map(it => it.slice())
      let nbStates = []
      for (let y = 0; y < this.m; y++) {
        for (let x = 0; x < this.n; x++) {
          let N = findNeighbors(oldTable, y, x, !noBoundry.checked)
          let cell = table[y][x]
          if (!cell) {
            if (N == 3) {
              table[y][x] = 1
              cellStatus.reborn++
              cellStatus.alive++
            } else {
              cellStatus.static++
              cellStatus.dead++
            }
          } else {
            if (N>=2 && N<=3) {
              cellStatus.static++
              cellStatus.alive++
            } else {
              table[y][x] = 0
              cellStatus.vanish++
              cellStatus.dead++
            }
          }
        }
      }
      return table
      function findNeighbors(table, y, x, hasBorder=true) {
        let count = 0
        for (let row = y-1; row <= y+1; row++) {
          for (let col = x-1; col <= x+1; col++) {
            if (hasBorder) {
              count += table[row]?.[col] || 0
            } else {
              count += table.at(row % m).at(col % n)
            }
          }
        }
        count -= table[y][x]
        return count
      }
    }

    renewTablefromUser() {
      let table = this.table
      world.cellStatus = {
        'mount': this.cellStatus.mount,
        'alive': '-',
        'dead': '-',
        'vanish': '-',
        'reborn': '-',
        'static': '-',
      }
      cells = document.querySelectorAll('.pixel')
      for (let cell of cells) {
        let x = cell.dataset.x
        let y = cell.dataset.y
        table[y][x] = cell.checked ? 1 : 0
      }
    }

    random() {
      this.table = this.createTable(this.m, this.n)
      return this.table
    }
  }

    let world = new ConwayLife()
    let cells

    // 制作一个表
    grid.style.minHeight = `${window.innerHeight - creatures.clientHeight}px`
    changeSize()

    rowRange.addEventListener('change', changeSize)
    colRange.addEventListener('change', changeSize)

    function changeSize() {
      m = parseInt(rowRange.value) // m是行 row
      n = parseInt(colRange.value) // n是列 column
      let rowRangeText = document.querySelector('#rowRange + span')
      let colRangeText = document.querySelector('#colRange + span')
      rowRangeText.textContent = '行: ' + rowRange.value
      colRangeText.textContent = '列: ' + colRange.value
      world.createTable(m, n)
      drawCheckbox()
      drawTable()
      world.cellStatus = {
        'mount': m * n,
        'alive': '-',
        'dead': '-',
        'vanish': '-',
        'reborn': '-',
        'static': '-',
      }
      evolveInfo()
    }


    // 画出表对应的checkbox图
    function drawCheckbox() {
      grid.innerHTML = ''
      for (let i = 0; i < m; i++) {
        let row = document.createElement('div')
        for (let j = 0; j < n; j++) {
          let checkbox = document.createElement('input')
          checkbox.type = 'checkbox'
          checkbox.setAttribute('data-x', `${j}`)
          checkbox.setAttribute('data-y', `${i}`)
          checkbox.classList = 'pixel'
          row.append(checkbox)
        }
        grid.append(row)
      }
    }

    // 同步表和cb图的值
    next.addEventListener('click', renewTable)
    function renewTable() {
      world.renewTablefromUser()
      world.renewTablefromEvolve()
      drawTable()
      evolveInfo()
    }

    function drawTable() {
      table = world.table
      for (let y = 0; y < m; y++) {
        for (let x = 0; x < n; x++) {
          let checkbox = document.querySelector(`[data-x="${x}"][data-y="${y}"]`)
          if (table[y][x]) {
            checkbox.checked = true
          } else {
            checkbox.checked = false
          }
        }
      }
    }

    // 随机功能
    random.addEventListener('click', e => {
      world.createTable(m, n)
      drawTable()
      world.renewTablefromUser()
      evolveInfo()
    })

    // 清空功能
    clear.addEventListener('click', e => {
      cells = document.querySelectorAll('.pixel')
      cells.forEach(it => {
        it.checked = false
      })
      renewTable()
    })

    //自动演化
    let intervalID
    autoplay.addEventListener('click', auto)
    function auto() {
      if (autoplay.checked) {
        intervalID = setInterval(renewTable,  selection.value)
      } else {
        if (intervalID) {
          clearInterval(intervalID)
        }
      }
    }

    // 进化信息
    function evolveInfo() {
      let text = `
      <span> 细胞总量: ${world.cellStatus.mount} </span>
      <span> 存活总数: ${world.cellStatus.alive} </span>
      <span> 消亡总数：${world.cellStatus.dead} </span>
      <span> 本轮稳定：${world.cellStatus.static} </span>
      <span> 本轮消亡：${world.cellStatus.vanish} </span>
      <span> 本轮复生：${world.cellStatus.reborn} </span>
      `
      let info = document.querySelector('.info')
      info.innerHTML = text
    }

  </script>

</body>
</html>
