<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>画布</title>
  <style>
    .drawing {
      display: inline-block;
      border: 1px solid;
    }
    svg {
      width: 200px;
      height: 200px;
      position: relative;
    }

    #eraserBlock {
      width: 10px;
      height: 10px;
      position: absolute;
      border:1px solid;
      color: transparent;
    }

    .tools {
      width: 100%;
      border-bottom: 2px solid;
      margin-bottom: 10px;
    }


    .penShapeSel:checked {
      background-color: blueviolet;
    }


    .drawing {
      width: 100%;
      height: 500px;
    }

    svg {
      width: 100%;
      height: 100%;
    }




  </style>
</head>
<body>
  <div class="tools">
    <span class="colors">
      <input type="color" value="#000000" id="colorSel">
      <input type="color" value="#ffffff" id="bgcolorSel">
    </span>
    <span class="strokeWidth">
      <input type="range" value="3" min="1" max="20" id="strokeWidthSel">
    </span>
    <span class="penShape">
      <label><input type="radio" name="shape" class='penShapeSel' id="shapeDot" >点</label>
      <label><input type="radio" name="shape" class='penShapeSel' id="shapeLine" >直线</label>
      <label><input type="radio" name="shape" class='penShapeSel' id="shapeCurve">曲线</label>
      <label><input type="radio" name="shape" class='penShapeSel' id="shapeRect">矩形</label>
      <label><input type="radio" name="shape" class='penShapeSel' id="shapeEllipse">椭圆</label>
      <label><input type="radio" name="shape" class='penShapeSel' id="eraser" checked>橡皮擦</label>
      <span id="eraserBlock" style="top:0;left:0"></span>
    </span>
    <span class="fill">
      <input type="checkbox" id="fillBlock" value="none"> 填充
    </span>
    <span class="others">
      <button id="undoAction">撤销</button>
      <button id="clearBoard">清空</button>
    </span>
  </div>
  <div class="drawing">
    <svg id="paintBoard">

    </svg>
  </div>
  <script>
    let svg = document.querySelector('svg')
    let clickCount = 0
    let lastX
    let lastY
    var endX
    var endY
    var controlX
    var controlY
    var centerX
    var centerY

    window.addEventListener('click', e => {
      if (fillBlock.checked) {
        fillBlock.value = bgcolorSel.value
      } else {
        fillBlock.value = 'none'
      }
    })

    svg.addEventListener('mousedown', function(e) {

      if (!shapeCurve.checked) {
        clickCount = 0
      }
      if (clickCount == 0) {
        lastX = e.offsetX
        lastY = e.offsetY
      }

      let line = elt('path', {
        d: `M ${lastX} ${lastY} L ${lastX} ${lastY}`,
        fill: fillBlock.value,
        stroke: colorSel.value,
        'stroke-width': strokeWidthSel.value,
      })

      if (shapeDot.checked) {
        window.addEventListener('mousemove', drawDot)
        svg.addEventListener('mouseup', function(e) {
          window.removeEventListener('mousemove', drawDot)
        })
      } else if (shapeLine.checked) {
        window.addEventListener('mousemove', drawLine)
        window.addEventListener('mouseup', function(e) {
        window.removeEventListener('mousemove', drawLine)
        })
      }
      if (shapeRect.checked) {
        window.addEventListener('mousemove', drawRect)
        window.addEventListener('mouseup', function(e) {
          window.removeEventListener('mousemove', drawRect)
        })
      } else if (shapeEllipse.checked) {
        window.addEventListener('mousemove', drawEllipse)
        window.addEventListener('mouseup', function(e) {
          window.removeEventListener('mousemove', drawEllipse)
        })
      }
      if (shapeCurve.checked) {
        if (clickCount == 0) {
          window.addEventListener('mousemove', drawLine)
          window.addEventListener('mouseup', function(e) {
            window.removeEventListener('mousemove', drawLine)
          })
          clickCount++
        } else if (clickCount == 1) {
          let ex = document.querySelector('svg path:last-child')
          svg.removeChild(ex)
          window.addEventListener('mousemove', drawQuadraticCurve)
          window.addEventListener('mouseup', function(e) {
            window.removeEventListener('mousemove', drawQuadraticCurve)
          })
          clickCount++
        } else if (clickCount == 2) {
          let ex = document.querySelector('svg path:last-child')
          svg.removeChild(ex)
          window.addEventListener('mousemove', drawCubeCurve)
          window.addEventListener('mouseup', function(e) {
            window.removeEventListener('mousemove', drawCubeCurve)
          })
          clickCount = 0
        }
      }
      if (eraser.checked) {
        window.addEventListener('mousemove', erase)
        window.addEventListener('mouseup', function(e) {
            window.removeEventListener('mousemove', erase)
        })
      }


      svg.appendChild(line)

      function drawDot(e) {
        let path = line.getAttribute('d')
        path += `L ${e.offsetX} ${e.offsetY}`
        line.setAttribute('d', path)
        line.setAttribute('fill', 'none')
      }

      function drawLine(e) {
        endX = e.offsetX
        endY = e.offsetY
        let path = `M ${lastX} ${lastY} L ${e.offsetX} ${e.offsetY}`
        line.setAttribute('d', path)
      }

      function drawRect(e) {
        let path
        if (e.shiftKey) {
        path = `M ${lastX} ${lastY} H ${e.offsetX} V ${e.offsetX - lastX + lastY} H ${lastX} V ${lastY}`
        } else {
          path = `M ${lastX} ${lastY} H ${e.offsetX} V ${e.offsetY} H ${lastX} V ${lastY}`
        }
        line.setAttribute('d', path)
      }

      function drawEllipse(e) {
        let rx = (e.offsetX-lastX)/2
        let ry = (e.offsetY-lastY)/2
        if (e.shiftKey) {
          ry = rx
        }
        let path = `M ${lastX} ${lastY}
                A ${rx} ${ry} 0 1 0 ${e.offsetX} ${e.offsetY}
                A ${rx} ${ry} 0 0 0 ${lastX} ${lastY}`
        line.setAttribute('d', path)
      }

      function drawQuadraticCurve(e) {
        controlX = e.offsetX
        controlY = e.offsetY
        let path = `M ${lastX} ${lastY} Q ${e.offsetX} ${e.offsetY} ${endX} ${endY}`
        line.setAttribute('d', path)
      }

      function drawCubeCurve(e) {
        let path = `M ${lastX} ${lastY} Q ${controlX} ${controlY} ${e.offsetX} ${e.offsetY} T ${ endX} ${endY}`
        line.setAttribute('d', path)
        console.log(clickCount)
      }


      // svg.addEventListener('mousemove',eraseFollow)

      // function eraseFollow(e) {
      //   if (eraser.checked) {
      //     eraserBlock.style.left = e.pageX -5 +  'px'
      //     eraserBlock.style.top = e.pageY -5 + 'px'
      //     console.log(e.pageX)
      //   }
      //   svg.addEventListener('mouseup', e => {
      //     svg.removeEventListener(eraseFollow)
      //   })
      // }

      function erase(e) {
        let path = line.getAttribute('d')
        path += `L ${e.offsetX} ${e.offsetY}`
        line.setAttribute('d', path)
        line.setAttribute('fill', 'none')
        line.setAttribute('stroke', 'white')
      }


    })



    // 清空
    clearBoard.addEventListener('click', e => {
      svg.innerHTML = ''
    })

    // 撤销
    undoAction.addEventListener('click', e => {
      let child = document.querySelector('svg path:last-child')
      svg.removeChild(child)
    })

    window.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.code =='KeyZ') {
        let line = document.querySelector('path:last-child')
        svg.removeChild(line)
      }

    })


    function elt(tagName, attrs={}, ...children) {
      let node = document.createElementNS('http://www.w3.org/2000/svg', tagName)
      for (let key in attrs) {
        let val = attrs[key]
        node.setAttribute(key, val)
      }
      for (let child of children) {
        if (typeof child == 'string') {
          child = document.createTextNode(child)
        } else {
          child = document.createElementNode(child)
        }
        node.appendChild(child)
      }
      return node
    }
  </script>
</body>
</html>
